# django官方教程（精简+注释版）

## 安装

记住用python3.5+。

```
pip3 install django
```

## 创建项目

每个项目对应一个域名。

```
django-admin startproject mysite
```

## 创建应用

每个应用对应一个子功能集合, 比如：user用户、order订单、goods商品。

在什么目录执行都可以, django会根据manage.py文件所在目录相对创建user子目录

```
python3 manage.py user
```

## 实现接口

编辑user/views.py

```
from django.http import HttpResponse

# Create your views here.
def index(request):
    return HttpResponse('Hello world')
```

## 配置子路由

新建user/urls.py, 采用相对导入可以降低心智负担。

```
from django.urls import path
from . import views

urlpatterns = [
    path('', views.index, name = 'index'),
]
```

## 配置全局路由

修改mysite/urls.py, 当访问/user对应子路由user.urls模块。

django会通过__import__动态完成user.urls的类加载, 我们需要书写以manage.py同级的包名。

这是因为python manage.py时会在sys.path中加入其所在目录作为包查找路径。

```
from django.contrib import admin
from django.urls import include, path

urlpatterns = [
    path('user/', include('user.urls')),
    path('admin/', admin.site.urls),
]
```

## 运行框架

运行，访问http://127.0.0.1:8000/user

```
python3 manage.py runserver
```

## 安装mysqlclient

为了访问mysql，在mac环境下进行如下操作：

```
brew install openssl
sudo LDFLAGS="-L/usr/local/opt/openssl/lib" pip3 install mysqlclient
```

## 创建数据库

在mysql中执行：

```
create database mysite
```

## 配置数据库

编辑mysite/settings.py：

```
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'mysite',
        'USER': 'root',
        'PASSWORD': 'baidu@123',
        'HOST': '127.0.0.1',
        'PORT': '3306',
    }
}
```

## 修改时区

编译mysite/settings.py：

```
TIME_ZONE = 'Asia/Shanghai'
```

## 初始化内置APP数据库

虽然这些功能不一定都用到, 但都做一下吧:

```
python3 manage.py migrate
```

产生了一些表：

```
mysql> use mysite;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+----------------------------+
| Tables_in_mysite           |
+----------------------------+
| auth_group                 |
| auth_group_permissions     |
| auth_permission            |
| auth_user                  |
| auth_user_groups           |
| auth_user_user_permissions |
| django_admin_log           |
| django_content_type        |
| django_migrations          |
| django_session             |
+----------------------------+
10 rows in set (0.00 sec)
```

## 创建model

model有2个用途, 一个是ORM操作数据库，一个是校验数据。

CharField(max_length=32)对应数据库varchar(32)：

```
from django.db import models

# Create your models here.
class User(models.Model):
    name = models.CharField(max_length=32)
    passwd = models.CharField(max_length = 32)
    create_date = models.DateTimeField()
```

## 用migration维护表结构

django支持从model导出表的schema定义, 并且可以将表结构变更生效到数据库。

注册user app，就和默认内置的app一样：

```
INSTALLED_APPS = [
    'user.apps.UserConfig', # 这里把user.apps模块的UserConfig类注册上来, 里面name属性标识了app
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
```

然后根据model生成schema：

```
python3 manage.py makemigrations user
```

查看migration文件：

```
cat user/migrations/0001_initial.py
# Generated by Django 2.1 on 2019-04-04 03:21

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=32)),
                ('passwd', models.CharField(max_length=32)),
                ('create_date', models.DateTimeField()),
            ],
        ),
    ]
```

然后生效到数据库，即0001_initial变更生效到了数据库：

```
python3 manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, user
Running migrations:
  Applying user.0001_initial... OK
```

查看数据库，发现表名为："app_model"：

```
mysql> show create table user_user\G;
*************************** 1. row ***************************
       Table: user_user
Create Table: CREATE TABLE `user_user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(32) NOT NULL,
  `passwd` varchar(32) NOT NULL,
  `create_date` datetime(6) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
1 row in set (0.00 sec)
```

并在django_migrations表中记录下了这次schema变更已经生效（前面的是内置app的migration生效记录）：

```
mysql> select * from django_migrations;
+----+--------------+------------------------------------------+----------------------------+
| id | app          | name                                     | applied                    |
+----+--------------+------------------------------------------+----------------------------+
|  1 | contenttypes | 0001_initial                             | 2019-04-04 03:00:57.683775 |
|  2 | auth         | 0001_initial                             | 2019-04-04 03:00:58.047838 |
|  3 | admin        | 0001_initial                             | 2019-04-04 03:00:58.143336 |
|  4 | admin        | 0002_logentry_remove_auto_add            | 2019-04-04 03:00:58.154404 |
|  5 | admin        | 0003_logentry_add_action_flag_choices    | 2019-04-04 03:00:58.168489 |
|  6 | contenttypes | 0002_remove_content_type_name            | 2019-04-04 03:00:58.231041 |
|  7 | auth         | 0002_alter_permission_name_max_length    | 2019-04-04 03:00:58.258178 |
|  8 | auth         | 0003_alter_user_email_max_length         | 2019-04-04 03:00:58.399291 |
|  9 | auth         | 0004_alter_user_username_opts            | 2019-04-04 03:00:58.419780 |
| 10 | auth         | 0005_alter_user_last_login_null          | 2019-04-04 03:00:58.461979 |
| 11 | auth         | 0006_require_contenttypes_0002           | 2019-04-04 03:00:58.464792 |
| 12 | auth         | 0007_alter_validators_add_error_messages | 2019-04-04 03:00:58.478683 |
| 13 | auth         | 0008_alter_user_username_max_length      | 2019-04-04 03:00:58.511075 |
| 14 | auth         | 0009_alter_user_last_name_max_length     | 2019-04-04 03:00:58.542999 |
| 15 | sessions     | 0001_initial                             | 2019-04-04 03:00:58.569779 |
| 16 | user         | 0001_initial                             | 2019-04-04 03:31:51.740560 |
+----+--------------+------------------------------------------+----------------------------+
```

这个表就可以防止同样的migration被重放。


现在再加一个字段, 注意生产中新增字段都要有默认值, migration会强制要求这一点：

```
from django.db import models

# Create your models here.
class User(models.Model):
    name = models.CharField(max_length = 32)
    passwd = models.CharField(max_length = 32)
    nickname = models.CharField(max_length=64, default = 'visitor')
    create_date = models.DateTimeField()

```

再次执行makemigration:

```
python3 manage.py makemigrations user
Migrations for 'user':
  user/migrations/0002_user_nickname.py
    - Add field nickname to user
```

产生了增量变化的命令：

```
cat user/migrations/0002_user_nickname.py
# Generated by Django 2.1 on 2019-04-04 03:25

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('user', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='user',
            name='nickname',
            field=models.CharField(default='visitor', max_length=64),
        ),
    ]
```

再次生效到数据库：

```
python3 manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, user
Running migrations:
  Applying user.0002_user_nickname... OK
```

查看数据库：

```
select * from django_migrations;
+----+--------------+------------------------------------------+----------------------------+
| id | app          | name                                     | applied                    |
+----+--------------+------------------------------------------+----------------------------+
|  1 | contenttypes | 0001_initial                             | 2019-04-04 03:00:57.683775 |
|  2 | auth         | 0001_initial                             | 2019-04-04 03:00:58.047838 |
|  3 | admin        | 0001_initial                             | 2019-04-04 03:00:58.143336 |
|  4 | admin        | 0002_logentry_remove_auto_add            | 2019-04-04 03:00:58.154404 |
|  5 | admin        | 0003_logentry_add_action_flag_choices    | 2019-04-04 03:00:58.168489 |
|  6 | contenttypes | 0002_remove_content_type_name            | 2019-04-04 03:00:58.231041 |
|  7 | auth         | 0002_alter_permission_name_max_length    | 2019-04-04 03:00:58.258178 |
|  8 | auth         | 0003_alter_user_email_max_length         | 2019-04-04 03:00:58.399291 |
|  9 | auth         | 0004_alter_user_username_opts            | 2019-04-04 03:00:58.419780 |
| 10 | auth         | 0005_alter_user_last_login_null          | 2019-04-04 03:00:58.461979 |
| 11 | auth         | 0006_require_contenttypes_0002           | 2019-04-04 03:00:58.464792 |
| 12 | auth         | 0007_alter_validators_add_error_messages | 2019-04-04 03:00:58.478683 |
| 13 | auth         | 0008_alter_user_username_max_length      | 2019-04-04 03:00:58.511075 |
| 14 | auth         | 0009_alter_user_last_name_max_length     | 2019-04-04 03:00:58.542999 |
| 15 | sessions     | 0001_initial                             | 2019-04-04 03:00:58.569779 |
| 16 | user         | 0001_initial                             | 2019-04-04 03:31:51.740560 |
| 17 | user         | 0002_user_nickname                       | 2019-04-04 03:35:56.442077 |
+----+--------------+------------------------------------------+----------------------------+
```

完整的user_user表结构：

```
 show create table user_user\G;
*************************** 1. row ***************************
       Table: user_user
Create Table: CREATE TABLE `user_user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(32) NOT NULL,
  `passwd` varchar(32) NOT NULL,
  `create_date` datetime(6) NOT NULL,
  `nickname` varchar(64) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
1 row in set (0.00 sec)
```

但是model里的default并没有带到表结构里，有点悲剧。

我建议还是手动建表，别用migrations了，仅作了解。

